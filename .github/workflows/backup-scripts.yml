name: è‡ªåŠ¨å¤‡ä»½è„šæœ¬

on:
  schedule:
    # æ¯1å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */1 * * *'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'config/scripts.json'

jobs:
  backup-scripts:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: å¤‡ä»½è„šæœ¬
      run: |
        # åˆ›å»ºè„šæœ¬ç›®å½•
        mkdir -p scripts
        
        # è¯»å–é…ç½®å¹¶ä¸‹è½½è„šæœ¬
        node -e "
        const fs = require('fs');
        const https = require('https');
        const http = require('http');
        const { URL } = require('url');
        
        const config = JSON.parse(fs.readFileSync('config/scripts.json', 'utf8'));
        
        async function downloadFile(url, filename) {
          return new Promise((resolve, reject) => {
            const parsedUrl = new URL(url);
            const client = parsedUrl.protocol === 'https:' ? https : http;
            
            const req = client.get(url, (res) => {
              if (res.statusCode === 200) {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  fs.writeFileSync(\`scripts/\${filename}\`, data);
                  console.log(\`å·²ä¸‹è½½: \${filename}\`);
                  resolve();
                });
              } else if (res.statusCode >= 300 && res.statusCode < 400) {
                // å¤„ç†é‡å®šå‘
                downloadFile(res.headers.location, filename).then(resolve).catch(reject);
              } else {
                reject(new Error(\`HTTP \${res.statusCode}: \${url}\`));
              }
            });
            
            req.on('error', reject);
            req.setTimeout(30000, () => {
              req.destroy();
              reject(new Error(\`è¶…æ—¶: \${url}\`));
            });
          });
        }
        
        async function main() {
          for (const script of config.scripts) {
            try {
              await downloadFile(script.url, script.filename);
              await new Promise(resolve => setTimeout(resolve, 1000)); // å»¶è¿Ÿ1ç§’
            } catch (error) {
              console.error(\`ä¸‹è½½å¤±è´¥ \${script.filename}: \${error.message}\`);
              // ç»§ç»­ä¸‹è½½å…¶ä»–è„šæœ¬ï¼Œä¸ä¸­æ–­æµç¨‹
            }
          }
        }
        
        main().catch(console.error);
        "
        
    - name: ç”Ÿæˆåˆé›†æ–‡ä»¶
      run: |
        node -e "
        const fs = require('fs');
        const crypto = require('crypto');
        
        const config = JSON.parse(fs.readFileSync('config/scripts.json', 'utf8'));
        
        const widgets = [];
        for (const script of config.scripts) {
          const scriptPath = \`scripts/\${script.filename}\`;
          if (fs.existsSync(scriptPath)) {
            const content = fs.readFileSync(scriptPath, 'utf8');
            const hash = crypto.createHash('sha256').update(content).digest('hex').substring(0, 8);
            
            widgets.push({
              id: script.id,
              title: script.title,
              description: script.description,
              requiredVersion: script.requiredVersion,
              version: \`1.0.\${hash.substring(0, 2)}\`,
              author: script.author,
              url: \`https://your-worker.your-subdomain.workers.dev/scripts/\${script.filename}\`
            });
          }
        }
        
        const collection = {
          title: config.collection.title,
          description: config.collection.description + ' (æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) + ')',
          icon: config.collection.icon,
          widgets: widgets
        };
        
        fs.writeFileSync('widgets.fwd', JSON.stringify(collection, null, 2));
        console.log('å·²ç”Ÿæˆ widgets.fwd');
        "
        
    - name: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      run: |
        echo "## ğŸ“Š å¤‡ä»½ç»Ÿè®¡" > backup-stats.md
        echo "" >> backup-stats.md
        echo "- ğŸ•’ æœ€åæ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S')" >> backup-stats.md
        echo "- ğŸ“ è„šæœ¬æ•°é‡: $(ls -1 scripts/ | wc -l)" >> backup-stats.md
        echo "- ğŸ“„ è„šæœ¬åˆ—è¡¨:" >> backup-stats.md
        echo "" >> backup-stats.md
        for file in scripts/*; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            echo "  - $(basename "$file") (${size} bytes)" >> backup-stats.md
          fi
        done
        
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨å¤‡ä»½è„šæœ¬ $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "å·²æäº¤æ›´æ”¹"
        fi