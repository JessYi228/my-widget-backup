name: è‡ªåŠ¨å¤‡ä»½è„šæœ¬

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */6 * * *'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'config/scripts.json'

jobs:
  backup-scripts:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PERSONAL_TOKEN || secrets.GITHUB_TOKEN }}
        persist-credentials: true
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: å¤‡ä»½è„šæœ¬
      run: |
        # åˆ›å»ºè„šæœ¬ç›®å½•
        mkdir -p scripts
        
        # è¯»å–é…ç½®å¹¶ä¸‹è½½è„šæœ¬
        node -e "
        const fs = require('fs');
        const https = require('https');
        const http = require('http');
        const { URL } = require('url');
        
        const config = JSON.parse(fs.readFileSync('config/scripts.json', 'utf8'));
        
        // æ™ºèƒ½è‡ªå­¦ä¹ ç‰ˆæœ¬æ£€æµ‹ç³»ç»Ÿ
        let versionCache = null;
        let lastSuccessfulVersion = null;
        
        // åŸºäºå®é™…Forwardç‰ˆæœ¬æ ¼å¼å’ŒæˆåŠŸç»éªŒç”Ÿæˆç‰ˆæœ¬å·
        function generateForwardVersions() {
          const now = new Date();
          const year = now.getFullYear();
          const month = (now.getMonth() + 1).toString().padStart(2, '0');
          const date = now.getDate().toString().padStart(2, '0');
          
          const versions = [];
          
          // å¦‚æœæœ‰ä¸Šæ¬¡æˆåŠŸçš„ç‰ˆæœ¬ï¼Œä¼˜å…ˆä½¿ç”¨ç±»ä¼¼çš„æ ¼å¼
          if (lastSuccessfulVersion) {
            console.log(\`åŸºäºæˆåŠŸç‰ˆæœ¬ \${lastSuccessfulVersion} ç”Ÿæˆç›¸ä¼¼ç‰ˆæœ¬\`);
            const match = lastSuccessfulVersion.match(/Forward\\/(\\d+\\.\\d+\\.\\d+) \\((\\d{8})(\\d{2})\\)/);
            if (match) {
              const [_, version, dateStr, buildNum] = match;
              
              // åŸºäºæˆåŠŸç‰ˆæœ¬ç”Ÿæˆç›¸è¿‘ç‰ˆæœ¬
              for (let i = 0; i < 5; i++) {
                const newBuildNum = (parseInt(buildNum) + i).toString().padStart(2, '0');
                versions.push(\`Forward/\${version} (\${dateStr}\${newBuildNum})\`);
              }
              
              // å°è¯•ç‰ˆæœ¬å·é€’å¢
              const versionParts = version.split('.');
              versionParts[2] = (parseInt(versionParts[2]) + 1).toString();
              const newVersion = versionParts.join('.');
              versions.push(\`Forward/\${newVersion} (\${dateStr}01)\`);
              versions.push(\`Forward/\${newVersion} (\${dateStr}02)\`);
            }
          }
          
          // åŸºäºå½“å‰æ—¥æœŸç”Ÿæˆç‰ˆæœ¬ (æ ¹æ®ä½ æä¾›çš„çœŸå®æ ¼å¼)
          const todayStr = \`\${year}\${month}\${date}\`;
          
          // ä»Šå¤©çš„ç‰ˆæœ¬ - æœ€é«˜ä¼˜å…ˆçº§
          for (let buildNum = 1; buildNum <= 10; buildNum++) {
            const buildStr = buildNum.toString().padStart(2, '0');
            versions.unshift(\`Forward/1.3.6 (\${todayStr}\${buildStr})\`);
            versions.unshift(\`Forward/1.3.7 (\${todayStr}\${buildStr})\`);
            versions.unshift(\`Forward/1.3.8 (\${todayStr}\${buildStr})\`);
            versions.unshift(\`Forward/1.4.0 (\${todayStr}\${buildStr})\`);
          }
          
          // æœ€è¿‘7å¤©çš„ç‰ˆæœ¬
          for (let dayOffset = 1; dayOffset <= 7; dayOffset++) {
            const targetDate = new Date(now);
            targetDate.setDate(targetDate.getDate() - dayOffset);
            
            const targetYear = targetDate.getFullYear();
            const targetMonth = (targetDate.getMonth() + 1).toString().padStart(2, '0');
            const targetDay = targetDate.getDate().toString().padStart(2, '0');
            const dateStr = \`\${targetYear}\${targetMonth}\${targetDay}\`;
            
            // æ¯å¤©çš„å‰5ä¸ªç‰ˆæœ¬
            for (let buildNum = 1; buildNum <= 5; buildNum++) {
              const buildStr = buildNum.toString().padStart(2, '0');
              versions.push(\`Forward/1.3.6 (\${dateStr}\${buildStr})\`);
              versions.push(\`Forward/1.3.7 (\${dateStr}\${buildStr})\`);
            }
          }
          
          return [...new Set(versions)]; // å»é‡
        }
        
        // å°è¯•ä»TestFlightè·å–çœŸå®ç‰ˆæœ¬ä¿¡æ¯
        async function fetchRealVersionFromTestFlight() {
          try {
            // å°è¯•è§£æTestFlighté¡µé¢è·å–ç‰ˆæœ¬ä¿¡æ¯
            console.log('å°è¯•ä»TestFlightè·å–çœŸå®ç‰ˆæœ¬ä¿¡æ¯...');
            
            // å·²çŸ¥çš„Forward TestFlighté“¾æ¥
            const testflightUrls = [
              'https://testflight.apple.com/join/uxkzBnhw', // Forward - æ–°è§†ç•Œ
              // å¯ä»¥æ·»åŠ æ›´å¤šå·²çŸ¥é“¾æ¥
            ];
            
            for (const url of testflightUrls) {
              try {
                const response = await fetch(url, {
                  headers: {
                    'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1',
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                  }
                });
                
                if (response.ok) {
                  const html = await response.text();
                  
                  // å°è¯•æå–ç‰ˆæœ¬ä¿¡æ¯çš„æ­£åˆ™è¡¨è¾¾å¼
                  const versionRegex = /Forward[\\s\\/](\\d+\\.\\d+\\.\\d+)\\s*\\((\\d{8})(\\d{2})\\)/gi;
                  const matches = [...html.matchAll(versionRegex)];
                  
                  if (matches.length > 0) {
                    const realVersions = matches.map(match => 
                      \`Forward/\${match[1]} (\${match[2]}\${match[3]})\`
                    );
                    console.log(\`ä»TestFlightè·å–åˆ°çœŸå®ç‰ˆæœ¬: \${realVersions.join(', ')}\`);
                    return realVersions;
                  }
                }
              } catch (error) {
                console.log(\`TestFlighté“¾æ¥ \${url} è®¿é—®å¤±è´¥: \${error.message}\`);
              }
            }
          } catch (error) {
            console.log(\`TestFlightç‰ˆæœ¬è·å–å¤±è´¥: \${error.message}\`);
          }
          
          return [];
        }
        
        async function getUserAgent(url, retryCount = 0) {
          try {
            const hostname = new URL(url).hostname;
            
            if (hostname === 'widgets-xd.vercel.app') {
              if (!versionCache) {
                // é¦–å…ˆå°è¯•ä»TestFlightè·å–çœŸå®ç‰ˆæœ¬
                const realVersions = await fetchRealVersionFromTestFlight();
                
                if (realVersions.length > 0) {
                  console.log(\`ä½¿ç”¨ä»TestFlightè·å–çš„çœŸå®ç‰ˆæœ¬\`);
                  versionCache = [...realVersions, ...generateForwardVersions()];
                } else {
                  console.log(\`TestFlightè·å–å¤±è´¥ï¼Œä½¿ç”¨æ™ºèƒ½ç”Ÿæˆçš„ç‰ˆæœ¬\`);
                  versionCache = generateForwardVersions();
                }
                
                console.log(\`ç”Ÿæˆäº† \${versionCache.length} ä¸ªå€™é€‰ç‰ˆæœ¬\`);
              }
              
              // è½®æ¢ä½¿ç”¨ç‰ˆæœ¬
              return versionCache[retryCount % versionCache.length];
            }
            
            return userAgents[hostname] || userAgents.default;
          } catch {
            return userAgents.default;
          }
        }
        
        async function downloadFile(url, filename, retryCount = 0) {
          return new Promise((resolve, reject) => {
            const parsedUrl = new URL(url);
            const client = parsedUrl.protocol === 'https:' ? https : http;
            
            // å¼‚æ­¥è·å–User-Agent
            getUserAgent(url, retryCount).then(userAgent => {
              const options = {
                hostname: parsedUrl.hostname,
                port: parsedUrl.port,
                path: parsedUrl.pathname + parsedUrl.search,
                method: 'GET',
                headers: {
                  'User-Agent': userAgent,
                  'Accept': 'text/plain, application/javascript, */*',
                  'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                  'Accept-Encoding': 'identity',
                  'Connection': 'close',
                  'Cache-Control': 'no-cache',
                  'Pragma': 'no-cache',
                  'Referer': 'https://testflight.apple.com/'
                },
                timeout: 30000
              };
              
              console.log(\`[é‡è¯•\${retryCount}] ä½¿ç”¨ User-Agent: \${userAgent.substring(0, 50)}...\`);
              
              const req = client.request(options, (res) => {
                console.log(\`è¯·æ±‚ \${filename}: \${res.statusCode} \${res.statusMessage}\`);
                
                if (res.statusCode === 200) {
                  let data = '';
                  res.setEncoding('utf8');
                  res.on('data', chunk => data += chunk);
                  res.on('end', () => {
                    // éªŒè¯è„šæœ¬å†…å®¹
                    if (data.trim().length < 50) {
                      reject(new Error(\`å†…å®¹è¿‡çŸ­ï¼Œå¯èƒ½ä¸æ˜¯æœ‰æ•ˆè„šæœ¬: \${data.substring(0, 100)}\`));
                      return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºé”™è¯¯é¡µé¢
                    if (data.includes('<html>') || data.includes('<!DOCTYPE')) {
                      reject(new Error('è¿”å›çš„æ˜¯HTMLé¡µé¢ï¼Œä¸æ˜¯JavaScriptè„šæœ¬'));
                      return;
                    }
                    
                    // è®°å½•æˆåŠŸçš„ç‰ˆæœ¬å·ç”¨äºå­¦ä¹ 
                    const hostname = new URL(url).hostname;
                    if (hostname === 'widgets-xd.vercel.app' && userAgent.includes('Forward/')) {
                      lastSuccessfulVersion = userAgent;
                      console.log(\`âœ… è®°å½•æˆåŠŸç‰ˆæœ¬: \${lastSuccessfulVersion}\`);
                    }
                    
                    fs.writeFileSync(\`scripts/\${filename}\`, data);
                    console.log(\`âœ… å·²ä¸‹è½½: \${filename} (\${data.length} bytes) [User-Agent: \${userAgent.substring(0, 30)}...]\`);
                    resolve();
                  });
                } else if (res.statusCode >= 300 && res.statusCode < 400 && res.headers.location) {
                  // å¤„ç†é‡å®šå‘
                  console.log(\`é‡å®šå‘åˆ°: \${res.headers.location}\`);
                  downloadFile(res.headers.location, filename, retryCount).then(resolve).catch(reject);
                } else if (res.statusCode === 403 && retryCount < 20) { // å¢åŠ åˆ°20æ¬¡é‡è¯•
                  console.log(\`æ”¶åˆ°403é”™è¯¯ï¼Œå°è¯•ä¸‹ä¸€ä¸ªç‰ˆæœ¬ (é‡è¯• \${retryCount + 1}/20)...\`);
                  setTimeout(() => {
                    downloadFile(url, filename, retryCount + 1).then(resolve).catch(reject);
                  }, 500 * (retryCount % 3 + 1)); // çŸ­å»¶è¿Ÿï¼Œå¿«é€Ÿåˆ‡æ¢ç‰ˆæœ¬
                } else {
                  reject(new Error(\`HTTP \${res.statusCode}: \${url} - \${res.statusMessage}\`));
                }
              });
              
              req.on('error', (error) => {
                reject(new Error(\`ç½‘ç»œé”™è¯¯: \${error.message}\`));
              });
              
              req.on('timeout', () => {
                req.destroy();
                reject(new Error(\`è¯·æ±‚è¶…æ—¶: \${url}\`));
              });
              
              req.end();
            }).catch(reject);
          });
        }
        
        async function main() {
          const results = [];
          for (const script of config.scripts) {
            try {
              console.log(\`å¼€å§‹ä¸‹è½½: \${script.filename} ä» \${script.url}\`);
              await downloadFile(script.url, script.filename);
              results.push({ script: script.filename, status: 'success' });
              // ä¸‹è½½æˆåŠŸåç¨ä½œå»¶è¿Ÿï¼Œé¿å…è¢«é™æµ
              await new Promise(resolve => setTimeout(resolve, 1500));
            } catch (error) {
              console.error(\`âŒ ä¸‹è½½å¤±è´¥ \${script.filename}: \${error.message}\`);
              results.push({ script: script.filename, status: 'failed', error: error.message });
              // å¤±è´¥åä¹Ÿå»¶è¿Ÿï¼Œç„¶åç»§ç»­ä¸‹è½½å…¶ä»–è„šæœ¬
              await new Promise(resolve => setTimeout(resolve, 2000));
            }
          }
          
          // è¾“å‡ºä¸‹è½½æ‘˜è¦
          console.log('\\nğŸ“Š ä¸‹è½½æ‘˜è¦:');
          const successful = results.filter(r => r.status === 'success');
          const failed = results.filter(r => r.status === 'failed');
          console.log(\`âœ… æˆåŠŸ: \${successful.length}ä¸ª\`);
          console.log(\`âŒ å¤±è´¥: \${failed.length}ä¸ª\`);
          
          if (failed.length > 0) {
            console.log('\\nå¤±è´¥çš„è„šæœ¬:');
            failed.forEach(f => console.log(\`  - \${f.script}: \${f.error}\`));
          }
        }
        
        main().catch(console.error);
        "
        
    - name: ç”Ÿæˆåˆé›†æ–‡ä»¶
      run: |
        node -e "
        const fs = require('fs');
        const crypto = require('crypto');
        
        const config = JSON.parse(fs.readFileSync('config/scripts.json', 'utf8'));
        
        const widgets = [];
        for (const script of config.scripts) {
          const scriptPath = \`scripts/\${script.filename}\`;
          if (fs.existsSync(scriptPath)) {
            const content = fs.readFileSync(scriptPath, 'utf8');
            const hash = crypto.createHash('sha256').update(content).digest('hex').substring(0, 8);
            
            widgets.push({
              id: script.id,
              title: script.title,
              description: script.description,
              requiredVersion: script.requiredVersion,
              version: \`1.0.\${hash.substring(0, 2)}\`,
              author: script.author,
              url: \`https://your-worker.your-subdomain.workers.dev/scripts/\${script.filename}\`
            });
          }
        }
        
        const collection = {
          title: config.collection.title,
          description: config.collection.description + ' (æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) + ')',
          icon: config.collection.icon,
          widgets: widgets
        };
        
        fs.writeFileSync('widgets.fwd', JSON.stringify(collection, null, 2));
        console.log('å·²ç”Ÿæˆ widgets.fwd');
        "
        
    - name: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      run: |
        echo "## ğŸ“Š å¤‡ä»½ç»Ÿè®¡" > backup-stats.md
        echo "" >> backup-stats.md
        echo "- ğŸ•’ æœ€åæ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S')" >> backup-stats.md
        echo "- ğŸ“ è„šæœ¬æ•°é‡: $(ls -1 scripts/ | wc -l)" >> backup-stats.md
        echo "- ğŸ“„ è„šæœ¬åˆ—è¡¨:" >> backup-stats.md
        echo "" >> backup-stats.md
        for file in scripts/*; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            echo "  - $(basename "$file") (${size} bytes)" >> backup-stats.md
          fi
        done
        
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨å¤‡ä»½è„šæœ¬ $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "å·²æäº¤æ›´æ”¹"
        fi