name: è‡ªåŠ¨å¤‡ä»½è„šæœ¬

on:
  schedule:
    # æ¯1å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */1 * * *'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'config/scripts.json'

jobs:
  backup-scripts:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: å¤‡ä»½è„šæœ¬
      run: |
        # åˆ›å»ºè„šæœ¬ç›®å½•
        mkdir -p scripts
        
        # è¯»å–é…ç½®å¹¶ä¸‹è½½è„šæœ¬
        node -e "
        const fs = require('fs');
        const https = require('https');
        const http = require('http');
        const { URL } = require('url');
        
        const config = JSON.parse(fs.readFileSync('config/scripts.json', 'utf8'));
        
        // æ™ºèƒ½ç‰ˆæœ¬æ¢æµ‹ç³»ç»Ÿ
        class VersionDetector {
          constructor() {
            this.successfulVersions = new Map(); // è®°å½•æˆåŠŸçš„ç‰ˆæœ¬
            this.knownPatterns = [
              // å·²çŸ¥å·¥ä½œçš„ç‰ˆæœ¬æ¨¡å¼
              'Forward/1.3.6 (2025082802)',
              'Forward/1.3.6 (2025082801)',
              
              // åŸºäºæ—¥æœŸçš„ç‰ˆæœ¬ç”Ÿæˆ
              ...this.generateDateBasedVersions(),
              
              // å¸¸è§ç‰ˆæœ¬æ¨¡å¼
              'Forward/1.3.7 (2025082701)',
              'Forward/1.3.8 (2025082601)',
              'Forward/1.4.0 (2025082801)',
              
              // iOSç‰ˆæœ¬æ ¼å¼ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
              'Forward/1.3.6 (iOS 18.1; iPhone 15 Pro)',
              'Forward/1.3.7 (iOS 18.0; iPhone 15 Pro Max)',
            ];
          }
          
          generateDateBasedVersions() {
            const versions = [];
            const today = new Date();
            
            // ç”Ÿæˆæœ€è¿‘7å¤©çš„ç‰ˆæœ¬
            for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
              const date = new Date(today);
              date.setDate(date.getDate() - dayOffset);
              
              const year = date.getFullYear();
              const month = (date.getMonth() + 1).toString().padStart(2, '0');
              const day = date.getDate().toString().padStart(2, '0');
              const dateStr = \`\${year}\${month}\${day}\`;
              
              // æ¯å¤©ç”Ÿæˆå¤šä¸ªå¯èƒ½çš„ç‰ˆæœ¬
              for (let build = 1; build <= 10; build++) {
                const buildStr = build.toString().padStart(2, '0');
                versions.push(\`Forward/1.3.6 (\${dateStr}\${buildStr})\`);
                if (build <= 3) {
                  versions.push(\`Forward/1.3.7 (\${dateStr}\${buildStr})\`);
                  versions.push(\`Forward/1.3.8 (\${dateStr}\${buildStr})\`);
                }
              }
            }
            return versions;
          }
          
          async detectVersion(url, maxAttempts = 20) {
            const hostname = new URL(url).hostname;
            
            // å¦‚æœä¸æ˜¯éœ€è¦ç‰¹æ®Šå¤„ç†çš„åŸŸåï¼Œè¿”å›é»˜è®¤User-Agent
            if (hostname !== 'widgets-xd.vercel.app') {
              return 'Mozilla/5.0 (compatible; GitHub-Actions-Script-Backup/1.0)';
            }
            
            // å¦‚æœä¹‹å‰æˆåŠŸè¿‡ï¼Œä¼˜å…ˆä½¿ç”¨æˆåŠŸçš„ç‰ˆæœ¬
            if (this.successfulVersions.has(hostname)) {
              const successful = this.successfulVersions.get(hostname);
              console.log(\`ä½¿ç”¨ä¹‹å‰æˆåŠŸçš„ç‰ˆæœ¬: \${successful}\`);
              return successful;
            }
            
            console.log(\`å¼€å§‹æ™ºèƒ½æ¢æµ‹ \${hostname} çš„æœ‰æ•ˆç‰ˆæœ¬...\`);
            
            // å¿«é€Ÿæ¢æµ‹æœ‰æ•ˆç‰ˆæœ¬
            for (let i = 0; i < Math.min(maxAttempts, this.knownPatterns.length); i++) {
              const version = this.knownPatterns[i];
              console.log(\`æ¢æµ‹ç¬¬\${i+1}æ¬¡: \${version}\`);
              
              try {
                const isValid = await this.testVersion(url, version);
                if (isValid) {
                  console.log(\`âœ… æ‰¾åˆ°æœ‰æ•ˆç‰ˆæœ¬: \${version}\`);
                  this.successfulVersions.set(hostname, version);
                  return version;
                }
              } catch (error) {
                console.log(\`âŒ ç‰ˆæœ¬æ— æ•ˆ: \${version} - \${error.message}\`);
              }
              
              // çŸ­æš‚å»¶è¿Ÿé¿å…è¢«é™æµ
              await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            console.log('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤User-Agent');
            return 'Mozilla/5.0 (compatible; GitHub-Actions-Script-Backup/1.0)';
          }
          
          async testVersion(url, userAgent) {
            return new Promise((resolve, reject) => {
              const parsedUrl = new URL(url);
              const client = parsedUrl.protocol === 'https:' ? https : http;
              
              const options = {
                hostname: parsedUrl.hostname,
                port: parsedUrl.port,
                path: parsedUrl.pathname,
                method: 'HEAD', // åªè·å–å¤´ä¿¡æ¯ï¼Œå¿«é€Ÿæµ‹è¯•
                headers: {
                  'User-Agent': userAgent,
                  'Accept': 'application/javascript, text/plain, */*'
                },
                timeout: 5000 // 5ç§’è¶…æ—¶
              };
              
              const req = client.request(options, (res) => {
                if (res.statusCode === 200) {
                  resolve(true);
                } else if (res.statusCode === 403) {
                  resolve(false);
                } else {
                  resolve(false);
                }
              });
              
              req.on('error', () => resolve(false));
              req.on('timeout', () => {
                req.destroy();
                resolve(false);
              });
              
              req.end();
            });
          }
        }
        
        const detector = new VersionDetector();
        
        async function downloadFile(url, filename) {
          return new Promise(async (resolve, reject) => {
            try {
              // æ™ºèƒ½æ¢æµ‹User-Agent
              const userAgent = await detector.detectVersion(url);
              
              const parsedUrl = new URL(url);
              const client = parsedUrl.protocol === 'https:' ? https : http;
              
              const options = {
                hostname: parsedUrl.hostname,
                port: parsedUrl.port,
                path: parsedUrl.pathname,
                headers: {
                  'User-Agent': userAgent,
                  'Accept': 'application/javascript, text/plain, */*'
                }
              };
              
              const req = client.request(options, (res) => {
                console.log(\`è¯·æ±‚ \${filename}: \${res.statusCode} (UA: \${userAgent.substring(0, 30)}...)\`);
                
                if (res.statusCode === 200) {
                  let data = '';
                  res.on('data', chunk => data += chunk);
                  res.on('end', () => {
                    // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JavaScriptå†…å®¹
                    if (data.trim().length < 100 || data.includes('<html>')) {
                      reject(new Error('è¿”å›å†…å®¹æ— æ•ˆ'));
                      return;
                    }
                    
                    fs.writeFileSync(\`scripts/\${filename}\`, data);
                    console.log(\`âœ… å·²ä¸‹è½½: \${filename} (\${data.length} bytes)\`);
                    resolve();
                  });
                } else if (res.statusCode >= 300 && res.statusCode < 400) {
                  // å¤„ç†é‡å®šå‘
                  downloadFile(res.headers.location, filename).then(resolve).catch(reject);
                } else {
                  reject(new Error(\`HTTP \${res.statusCode}: \${url}\`));
                }
              });
              
              req.on('error', reject);
              req.setTimeout(30000, () => {
                req.destroy();
                reject(new Error(\`è¶…æ—¶: \${url}\`));
              });
              
              req.end();
            } catch (error) {
              reject(error);
            }
          });
        }
        
        async function main() {
          for (const script of config.scripts) {
            try {
              await downloadFile(script.url, script.filename);
              await new Promise(resolve => setTimeout(resolve, 1000)); // å»¶è¿Ÿ1ç§’
            } catch (error) {
              console.error(\`ä¸‹è½½å¤±è´¥ \${script.filename}: \${error.message}\`);
              // ç»§ç»­ä¸‹è½½å…¶ä»–è„šæœ¬ï¼Œä¸ä¸­æ–­æµç¨‹
            }
          }
        }
        
        main().catch(console.error);
        "
        
    - name: ç”Ÿæˆåˆé›†æ–‡ä»¶
      run: |
        node -e "
        const fs = require('fs');
        const crypto = require('crypto');
        
        const config = JSON.parse(fs.readFileSync('config/scripts.json', 'utf8'));
        
        const widgets = [];
        for (const script of config.scripts) {
          const scriptPath = \`scripts/\${script.filename}\`;
          if (fs.existsSync(scriptPath)) {
            const content = fs.readFileSync(scriptPath, 'utf8');
            const hash = crypto.createHash('sha256').update(content).digest('hex').substring(0, 8);
            
            widgets.push({
              id: script.id,
              title: script.title,
              description: script.description,
              requiredVersion: script.requiredVersion,
              version: \`1.0.\${hash.substring(0, 2)}\`,
              author: script.author,
              url: \`https://summer-water-d054.j1395468936.workers.dev/scripts/\${script.filename}\`
            });
          }
        }
        
        const collection = {
          title: config.collection.title,
          description: config.collection.description + ' (æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) + ')',
          icon: config.collection.icon,
          widgets: widgets
        };
        
        fs.writeFileSync('widgets.fwd', JSON.stringify(collection, null, 2));
        console.log('å·²ç”Ÿæˆ widgets.fwd');
        "
        
    - name: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      run: |
        echo "## ğŸ“Š å¤‡ä»½ç»Ÿè®¡" > backup-stats.md
        echo "" >> backup-stats.md
        echo "- ğŸ•’ æœ€åæ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S')" >> backup-stats.md
        echo "- ğŸ“ è„šæœ¬æ•°é‡: $(ls -1 scripts/ | wc -l)" >> backup-stats.md
        echo "- ğŸ“„ è„šæœ¬åˆ—è¡¨:" >> backup-stats.md
        echo "" >> backup-stats.md
        for file in scripts/*; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            echo "  - $(basename "$file") (${size} bytes)" >> backup-stats.md
          fi
        done
        
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨å¤‡ä»½è„šæœ¬ $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "å·²æäº¤æ›´æ”¹"
        fi